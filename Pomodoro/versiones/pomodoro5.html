<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pomodoro ‚Äî App de descanso</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
  <style>
    :root {
  /* Tema Oscuro (por defecto) */
  --bg-grad-start: #071223;
  --bg-grad-end: #0f1724;
  --card-bg: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  --card-shadow: rgba(2,6,23,0.7);
  --text-main: #e6eef6;
  --text-muted: #9aa4b2;
  --accent: #ff6b6b;
  --accent-2: #7c5cff;
  --glass: rgba(255,255,255,0.03);
  --ring-bg: rgba(255,255,255,0.06);
  --btn-pause-bg: #263042;
  --input-border: rgba(255,255,255,0.04);
  --section-bg: rgba(255,255,255,0.02);
  --hist-item-bg: rgba(255,255,255,0.01);
  --success: #22c55e;
}

html[data-theme="light"] {
  --bg-grad-start: #f0f4f8;
  --bg-grad-end: #d9e2ec;
  --card-bg: linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.5));
  --card-shadow: rgba(100,116,139,0.2);
  --text-main: #1e293b;
  --text-muted: #475569;
  --accent: #ef4444;
  --accent-2: #6d28d9;
  --glass: rgba(0,0,0,0.03);
  --ring-bg: rgba(0,0,0,0.08);
  --btn-pause-bg: #cbd5e1;
  --input-border: rgba(0,0,0,0.1);
  --section-bg: rgba(0,0,0,0.02);
  --hist-item-bg: rgba(0,0,0,0.01);
}

*{box-sizing:border-box}
html,body{height:103%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%); color:var(--text-main); transition: background 0.3s, color 0.3s;}



.app {
  min-height: 100vh;
  display: flex;
 align-items: stretch; /* <-- CAMBIA 'center' POR 'stretch' */
  justify-content: center;
  padding: 0; /* <--- CORREGIDO */
}
.card {
  width: 980px; 
  max-width: 100%;
  background: var(--card-bg);
  padding: 24px;
  display: grid;
  grid-template-columns: 360px 1fr;
  gap: 20px;
  position: relative;
  transition: background 0.3s;
  border-radius: 0;   /* <--- CORREGIDO */
  box-shadow: none;     /* <--- CORREGIDO: Sombra eliminada */
}

/* Panel Izquierdo (Temporizador) */
.left{display:flex;flex-direction:column;align-items:center;gap:18px;padding:20px;border-radius:12px;background:var(--glass)}
.mode-controls{display:flex;gap:10px}
.mode-btn{background:transparent;border:1px solid var(--input-border);padding:8px 12px;border-radius:10px;color:var(--text-muted);cursor:pointer}
.mode-btn.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;border:0}

.ring{ position: relative; width:260px;height:260px;display:grid;place-items:center }
.time{font-size:48px;font-weight:700;letter-spacing:1px}
.label{color:var(--text-muted);font-size:13px;margin-top:6px}

.coin-animation {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 28px;
    font-weight: bold;
    color: var(--success);
    opacity: 0;
    transition: all 1.5s ease-out;
    z-index: 10;
    pointer-events: none;
}
.coin-animation.show {
    transform: translate(-50%, -150%);
    opacity: 1;
}

.task-input-container { width: 100%; max-width: 280px; }
#taskInput {
  width: 100%; padding: 10px; border-radius: 8px; font-size: 14px; text-align: center;
  border: 1px solid var(--input-border); background: transparent; color: var(--text-main);
}
#taskInput::placeholder { color: var(--text-muted); }

.controls{display:flex;gap:10px}
.btn{padding:10px 16px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
.btn.start{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white}
.btn.pause{background:var(--btn-pause-bg);color: var(--text-main);}
.btn.reset{background:transparent;border:1px solid var(--input-border);color:var(--text-muted)}

/* Panel Derecho (Configuraci√≥n e Historial) */
.right{display:flex;flex-direction:column;gap:16px;padding:18px}
.section{background:var(--section-bg);padding:14px;border-radius:10px}
.section h3{margin:0 0 8px 0;font-size:15px}

/* CORREGIDO: Selector arreglado y estilos de la tienda (sin duplicados) */
.coin-display-section {
    background: linear-gradient(45deg, rgba(255, 215, 0, 0.1), transparent);
}
.coin-display {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 24px;
    font-weight: 600;
}
.coin-icon {
    font-size: 28px;
}
.shop-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
}
.shop-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: var(--hist-item-bg);
    border-radius: 8px;
    border-left: 3px solid transparent;
}
.shop-item.selected {
    border-left-color: var(--accent-2);
}
.shop-item-details {
    display: flex;
    flex-direction: column;
}
.shop-item-name {
    font-weight: 600;
}
.shop-btn {
    padding: 6px 12px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 13px;
    transition: background-color 0.2s;
}
.shop-btn.buy {
    background-color: var(--success);
    color: white;
}
.shop-btn.select {
    background-color: var(--accent-2);
    color: white;
}
.shop-btn:disabled {
    background-color: var(--btn-pause-bg);
    color: var(--text-muted);
    cursor: not-allowed;
}

.field{display:flex;gap:8px;align-items:center}
.field label{min-width:160px;color:var(--text-muted);font-size:13px}
.field input[type=number], .theme-select {width:100%;padding:8px;border-radius:8px;border:1px solid var(--input-border);background:transparent;color:inherit; font-family: inherit;}

.toggle{display:inline-flex;align-items:center;gap:8px; cursor:pointer;}
.small{font-size:13px;color:var(--text-muted)}
.history {
  /* CORRECCI√ìN: Establecemos una altura m√°xima que equivale a unas 3-4 entradas */
  max-height: 120px; 
  overflow-y: auto; /* Muestra la barra de scroll solo cuando es necesario */
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.hist-item{display:flex;flex-direction:column; padding:8px;border-radius:8px;background:var(--hist-item-bg);font-size:13px; gap: 4px;}
.hist-item-header{display:flex; justify-content:space-between;}
footer{ font-size: 11px; color: var(--text-muted); text-align: center; margin-top: 5px; }
/* --- Men√∫ M√≥vil --- */
.hamburger-btn, .close-btn { display: none; }
@media (max-width: 880px){
  .app { padding: 0; }
  .card{grid-template-columns:1fr; height: 100vh; border-radius: 0; padding: 16px; gap: 0;}
  .left{justify-content: center; background: transparent;}
  .hamburger-btn {
    display: flex; flex-direction: column; justify-content: space-around;
    width: 30px; height: 30px; background: transparent; border: none; cursor: pointer;
    padding: 0; position: absolute; top: 24px; left: 24px; z-index: 1001;
  }
  .hamburger-btn span { width: 30px; height: 3px; background: var(--text-muted); border-radius: 5px; }
  .card.menu-active .hamburger-btn { display: none; }
  .right{
    position: fixed; top: 0; left: 0; height: 100%; width: 300px; max-width: 80%;
    background: var(--bg-grad-end); z-index: 1000;
    transform: translateX(-100%); transition: transform 0.3s ease-in-out;
    box-shadow: 5px 0px 20px rgba(0,0,0,0.3);
    overflow-y: auto; padding-top: 60px;
  }
  .right.menu-open { transform: translateX(0); }
  .close-btn {
    display: block; position: absolute; top: 15px; right: 15px;
    background: transparent; border: none; color: var(--text-main); font-size: 32px; cursor: pointer;
  }
}

.toast {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  background-color: var(--accent-2); color: white; padding: 12px 24px;
  border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s, bottom 0.3s;
  z-index: 2000;
}
.toast.show {
  opacity: 1; visibility: visible; bottom: 30px;
}
  </style>
</head>
<body>
  <div class="app">
    <main class="card" role="application" aria-label="Timer Pomodoro">
      <button class="hamburger-btn" id="hamburgerBtn" aria-label="Abrir men√∫">
        <span></span><span></span><span></span>
      </button>

      <div class="left">
        <div class="mode-controls" role="tablist">
          <button class="mode-btn active" data-mode="pomodoro" role="tab">Pomodoro</button>
          <button class="mode-btn" data-mode="short" role="tab">Descanso corto</button>
          <button class="mode-btn" data-mode="long" role="tab">Descanso largo</button>
        </div>
        <div class="ring" aria-hidden="false">
          <div class="coin-animation" id="coinAnimation">+1 ü™ô</div>
          <svg id="progressSvg" viewBox="0 0 120 120" width="260" height="260">
            <defs>
              <linearGradient id="g1" x1="0%" x2="100%"><stop offset="0%" stop-color="var(--accent)" /><stop offset="100%" stop-color="var(--accent-2)" /></linearGradient>
            </defs>
            <g transform="translate(60,60)">
              <circle r="52" stroke="var(--ring-bg)" stroke-width="12" fill="none"></circle>
              <circle id="progressCircle" r="52" stroke="url(#g1)" stroke-width="12" stroke-linecap="round" fill="none" stroke-dasharray="326.7256" stroke-dashoffset="0" transform="rotate(-90)"></circle>
            </g>
          </svg>
          <div style="position:absolute;text-align:center;">
            <div class="time" id="timeDisplay" aria-live="polite">25:00</div>
            <div class="label" id="modeLabel">Enfoque</div>
          </div>
        </div>
        
        <div class="task-input-container">
          <input type="text" id="taskInput" placeholder="¬øEn qu√© te enfocas?">
        </div>

        <div class="controls">
          <button class="btn start" id="startBtn">Iniciar</button>
          <button class="btn pause" id="pauseBtn" style="display:none">Pausar</button>
          <button class="btn reset" id="resetBtn">Reiniciar</button>
        </div>
        <div class="small">Atajos: <strong>Espacio</strong> iniciar/pausar ‚Ä¢ <strong>R</strong> reiniciar</div>
      </div>

      <aside class="right" id="rightPanel">
        <button class="close-btn" id="closeMenuBtn" aria-label="Cerrar men√∫">&times;</button>
        
        <section class="section coin-display-section">
            <h3>Tus Recompensas</h3>
            <div class="coin-display" id="coinDisplay">
                <span class="coin-icon">ü™ô</span>
                <span id="coinCount">0</span>
            </div>
        </section>

        <section class="section">
            <h3>üè™ Tienda</h3>
            <div class="shop-container" id="shopContainer"></div>
        </section>

        <section class="section">
          <h3>Configuraci√≥n</h3>
           <div class="field">
              <label for="theme-selector" class="small">Tema visual</label>
              <select id="theme-selector" class="theme-select">
                  <option value="dark">Oscuro</option>
                  <option value="light">Claro</option>
              </select>
          </div>
          <div class="field"><label for="pomodoroInput">Duraci√≥n Pomodoro (min)</label><input id="pomodoroInput" type="number" min="1" max="180" value="25"></div>
          <div class="field"><label for="shortInput">Descanso corto (min)</label><input id="shortInput" type="number" min="1" max="60" value="5"></div>
          <div class="field"><label for="longInput">Descanso largo (min)</label><input id="longInput" type="number" min="1" max="120" value="15"></div>
          <div class="field"><label for="cyclesInput">Ciclos hasta descanso largo</label><input id="cyclesInput" type="number" min="1" max="10" value="4"></div>
          
          <div class="field">
              <label for="soundSelector" class="small">Sonido de alarma</label>
              <select id="soundSelector" class="theme-select"></select>
          </div>

          <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap: wrap">
            <label class="toggle"><input type="checkbox" id="autoNext"> <span class="small">Autoplay siguiente</span></label>
            <label class="toggle"><input type="checkbox" id="notifToggle"> <span class="small">Notificaciones</span></label>
          </div>
           <div style="margin-top:10px;display:flex;gap:8px;"><button class="btn" id="saveSettings">Guardar</button><button class="btn" id="resetSettings">Restablecer</button></div>
        </section>

        <section class="section">
          <h3>Historial</h3>
          <div class="history" id="history"></div>
        </section>

        <footer>@Copyright Germ√°n Narciso C√≥rdoba</footer>
      </aside>
    </main>
  </div>
  
  <div id="toast" class="toast"></div>
  
  <audio id="sound_beep" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" preload="auto"></audio>
  <audio id="sound_bell" src="data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEARKwAARKwAAABAAgAZGF0YUgAAABWAgAEBAEACQAKEAsgCgAKCAsgCgAKCAsgCgAKCAsgCgAKCAsgCgAKCAsgCgAKCAsgCgAKCAsgCgAKCAsgCgAKCAsgCgAKCAsgCgAKCAsgCgAKCAsgCgAKCAsgCgAKCAsgCgAKCA==" preload="auto"></audio>
  <audio id="sound_chime" src="data:audio/wav;base64,UklGRjoAAABXQVZFZm10IBAAAAABAAIARKwAABCxAgAEABAAZGF0YRYAAAD///////////8AAAAAAAAAAAAAAAAAAAAA//8CAP/5/7n/yP/2/9H/jP+9/3//ov/x/2v/vv/S/9T/zf+z/8H/x/+t/6v/qP+w/6v/qP+w/6v/qP+v/6z/rv+v/6//rP+u/6//rP+w/6v/qP+t/6r/qg==" preload="auto"></audio>

  <script>
    // CORREGIDO: Toda la l√≥gica est√° ahora correctamente encapsulada dentro de este objeto.
const pomodoroApp = {
  elements: {
    card: document.querySelector('.card'),
    timeDisplay: document.getElementById('timeDisplay'),
    modeLabel: document.getElementById('modeLabel'),
    progressCircle: document.getElementById('progressCircle'),
    historyEl: document.getElementById('history'),
    taskInput: document.getElementById('taskInput'),
    toast: document.getElementById('toast'),
    coinAnimation: document.getElementById('coinAnimation'),
    coinDisplay: document.getElementById('coinDisplay'),
    coinCount: document.getElementById('coinCount'),
    shopContainer: document.getElementById('shopContainer'),
    soundSelector: document.getElementById('soundSelector'),
    startBtn: document.getElementById('startBtn'),
    pauseBtn: document.getElementById('pauseBtn'),
    resetBtn: document.getElementById('resetBtn'),
    modeBtns: document.querySelectorAll('.mode-btn'),
    pomodoroInput: document.getElementById('pomodoroInput'),
    shortInput: document.getElementById('shortInput'),
    longInput: document.getElementById('longInput'),
    cyclesInput: document.getElementById('cyclesInput'),
    autoNext: document.getElementById('autoNext'),
    notifToggle: document.getElementById('notifToggle'),
    saveSettings: document.getElementById('saveSettings'),
    resetSettings: document.getElementById('resetSettings'),
    hamburgerBtn: document.getElementById('hamburgerBtn'),
    closeMenuBtn: document.getElementById('closeMenuBtn'),
    rightPanel: document.getElementById('rightPanel'),
    themeSelector: document.getElementById('theme-selector')
  },

  state: {
    mode: 'pomodoro',
    running: false,
    timer: null,
    remaining: 0,
    total: 0,
    completedCycles: 0,
    originalTitle: document.title,
    coins: 0,
    selectedSound: 'sound_beep',
  },
  
  config: {
    CIRCLE_CIRC: 2 * Math.PI * 52,
  },

  shop: {
    items: [
      { id: 'sound_beep', name: 'Beep Cl√°sico', type: 'sound', cost: 0, unlocked: true, audioEl: document.getElementById('sound_beep') },
      { id: 'sound_bell', name: 'Campana', type: 'sound', cost: 5, unlocked: false, audioEl: document.getElementById('sound_bell') },
      { id: 'sound_chime', name: 'Timbre', type: 'sound', cost: 10, unlocked: false, audioEl: document.getElementById('sound_chime') }
    ]
  },

  // CORREGIDO: Todas las funciones de la aplicaci√≥n est√°n dentro de este objeto "methods"
  methods: {
    formatTime(sec) {
      const m = Math.floor(sec / 60).toString().padStart(2, '0');
      const s = (sec % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    },

    updateDisplay() {
      const formattedTime = this.formatTime(pomodoroApp.state.remaining);
      pomodoroApp.elements.timeDisplay.textContent = formattedTime;
      
      const percent = (pomodoroApp.state.total - pomodoroApp.state.remaining) / pomodoroApp.state.total;
      const dash = pomodoroApp.config.CIRCLE_CIRC * (1 - percent);
      pomodoroApp.elements.progressCircle.style.strokeDashoffset = dash;

      document.title = `(${formattedTime}) ${pomodoroApp.state.originalTitle}`;
    },

    setMode(newMode, resetTimer = true) {
      pomodoroApp.state.mode = newMode;
      const { modeBtns, modeLabel, pomodoroInput, shortInput, longInput } = pomodoroApp.elements;
      modeBtns.forEach(b => b.classList.toggle('active', b.dataset.mode === newMode));

      switch (newMode) {
        case 'pomodoro':
          pomodoroApp.state.total = Number(pomodoroInput.value) * 60;
          modeLabel.textContent = 'Enfoque';
          break;
        case 'short':
          pomodoroApp.state.total = Number(shortInput.value) * 60;
          modeLabel.textContent = 'Descanso corto';
          break;
        case 'long':
          pomodoroApp.state.total = Number(longInput.value) * 60;
          modeLabel.textContent = 'Descanso largo';
          break;
      }

      if (resetTimer) {
        pomodoroApp.state.remaining = pomodoroApp.state.total;
      }
      this.updateDisplay();
    },
    
    tick() {
      if (pomodoroApp.state.remaining <= 0) {
        clearInterval(pomodoroApp.state.timer);
        pomodoroApp.state.timer = null;
        pomodoroApp.state.running = false;
        this.onFinish();
        return;
      }
      pomodoroApp.state.remaining--;
      this.updateDisplay();
    },

    onFinish() {
      this.playSound();
      this.addHistoryEntry(pomodoroApp.state.mode, 'completado');
      document.title = `‚úÖ ${pomodoroApp.state.originalTitle}`;

      if (pomodoroApp.state.mode === 'pomodoro') {
        pomodoroApp.state.completedCycles++;
        this.addCoin();
      }

      if (pomodoroApp.elements.autoNext.checked) {
        const cyclesToLong = Number(pomodoroApp.elements.cyclesInput.value);
        if (pomodoroApp.state.mode === 'pomodoro') {
          const nextMode = (pomodoroApp.state.completedCycles % cyclesToLong === 0) ? 'long' : 'short';
          this.setMode(nextMode);
          this.startTimer();
        } else {
          this.setMode('pomodoro');
          this.startTimer();
        }
      } else {
        pomodoroApp.elements.startBtn.style.display = 'inline-block';
        pomodoroApp.elements.pauseBtn.style.display = 'none';
      }
    },

    startTimer() {
      if (pomodoroApp.state.running) return;
      pomodoroApp.state.running = true;
      this.addHistoryEntry(pomodoroApp.state.mode, 'iniciado');
      if (!pomodoroApp.state.timer) {
        pomodoroApp.state.timer = setInterval(() => this.tick(), 1000);
      }
      pomodoroApp.elements.startBtn.style.display = 'none';
      pomodoroApp.elements.pauseBtn.style.display = 'inline-block';
    },

    pauseTimer() {
      pomodoroApp.state.running = false;
      clearInterval(pomodoroApp.state.timer);
      pomodoroApp.state.timer = null;
      this.addHistoryEntry(pomodoroApp.state.mode, 'pausado');
      pomodoroApp.elements.startBtn.style.display = 'inline-block';
      pomodoroApp.elements.pauseBtn.style.display = 'none';
    },

    resetTimer() {
      pomodoroApp.state.running = false;
      clearInterval(pomodoroApp.state.timer);
      pomodoroApp.state.timer = null;
      this.setMode(pomodoroApp.state.mode, true);
      this.addHistoryEntry(pomodoroApp.state.mode, 'reiniciado');
      pomodoroApp.elements.startBtn.style.display = 'inline-block';
      pomodoroApp.elements.pauseBtn.style.display = 'none';
      document.title = pomodoroApp.state.originalTitle;
    },

    addHistoryEntry(mode, action) {
      const hist = JSON.parse(localStorage.getItem('pomodoro.history') || '[]');
      const task = pomodoroApp.elements.taskInput.value.trim();
      hist.unshift({ mode, action, time: new Date().toISOString(), task });
      if (hist.length > 20) hist.pop();
      localStorage.setItem('pomodoro.history', JSON.stringify(hist));
      this.renderHistory(hist);
    },

    renderHistory(hist) {
      pomodoroApp.elements.historyEl.innerHTML = '';
      hist.forEach(h => {
        const d = new Date(h.time);
        const el = document.createElement('div');
        el.className = 'hist-item';
        const modeText = { pomodoro: 'Pomodoro', short: 'Descanso Corto', long: 'Descanso Largo' }[h.mode] || h.mode;
        const actionText = h.action ? h.action.charAt(0).toUpperCase() + h.action.slice(1) : '';
        const taskHTML = h.task ? `<div class="small">Tarea: <em>${h.task}</em></div>` : '';
        el.innerHTML = `<div class="hist-item-header"><span>${modeText} - <strong>${actionText}</strong></span><span class="small">${d.toLocaleString()}</span></div>${taskHTML}`;
        pomodoroApp.elements.historyEl.appendChild(el);
      });
    },

    addCoin() {
      pomodoroApp.state.coins++;
      this.updateCoinDisplay();
      this.animateCoinGain();
      this.saveSettingsToStorage();
      this.renderShop();
    },

    updateCoinDisplay() {
      pomodoroApp.elements.coinCount.textContent = pomodoroApp.state.coins;
    },

    animateCoinGain() {
      const { coinAnimation } = pomodoroApp.elements;
      coinAnimation.classList.add('show');
      setTimeout(() => {
        coinAnimation.classList.remove('show');
      }, 1500);
    },

    renderShop() {
      const { shopContainer } = pomodoroApp.elements;
      shopContainer.innerHTML = '';
      pomodoroApp.shop.items.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'shop-item';
        if (pomodoroApp.state.selectedSound === item.id) {
          itemEl.classList.add('selected');
        }
        let buttonHTML;
        if (item.unlocked) {
          buttonHTML = (pomodoroApp.state.selectedSound === item.id)
            ? `<button class="shop-btn select" disabled>Seleccionado</button>`
            : `<button class="shop-btn select" data-item-id="${item.id}">Seleccionar</button>`;
        } else {
          buttonHTML = `<button class="shop-btn buy" data-item-id="${item.id}" ${pomodoroApp.state.coins < item.cost ? 'disabled' : ''}>Comprar (${item.cost} ü™ô)</button>`;
        }
        itemEl.innerHTML = `<div class="shop-item-details"><span class="shop-item-name">${item.name}</span></div>${buttonHTML}`;
        shopContainer.appendChild(itemEl);
      });
    },

    handleShopAction(e) {
      if (!e.target.matches('.shop-btn')) return;
      const itemId = e.target.dataset.itemId;
      const item = pomodoroApp.shop.items.find(i => i.id === itemId);
      if (!item) return;

      if (!item.unlocked) {
        if (pomodoroApp.state.coins >= item.cost) {
          pomodoroApp.state.coins -= item.cost;
          item.unlocked = true;
          this.showToast(`${item.name} desbloqueado!`);
        }
      } else {
        pomodoroApp.state.selectedSound = item.id;
        this.showToast(`${item.name} seleccionado.`);
      }
      
      this.updateCoinDisplay();
      this.saveSettingsToStorage();
      this.renderShop();
      this.renderSoundSelector();
    },
    
    renderSoundSelector() {
      const { soundSelector } = pomodoroApp.elements;
      soundSelector.innerHTML = '';
      pomodoroApp.shop.items.forEach(item => {
        if (item.type === 'sound' && item.unlocked) {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = item.name;
          if (item.id === pomodoroApp.state.selectedSound) {
            option.selected = true;
          }
          soundSelector.appendChild(option);
        }
      });
    },

    playSound() {
      const soundItem = pomodoroApp.shop.items.find(item => item.id === pomodoroApp.state.selectedSound);
      if (soundItem && soundItem.audioEl) {
        try {
          soundItem.audioEl.currentTime = 0;
          soundItem.audioEl.play();
        } catch (e) {
          console.error("Error al reproducir el sonido:", e);
        }
      }
    },

    loadSettings() {
      const s = JSON.parse(localStorage.getItem('pomodoro.settings') || '{}');
      const { pomodoroInput, shortInput, longInput, cyclesInput, autoNext, notifToggle, themeSelector } = pomodoroApp.elements;
      
      pomodoroInput.value = s.pomodoro || 25;
      shortInput.value = s.short || 5;
      longInput.value = s.long || 15;
      cyclesInput.value = s.cycles || 4;
      autoNext.checked = s.autoNext ?? true;
      notifToggle.checked = s.notif ?? false;
      
      const theme = s.theme || 'dark';
      document.documentElement.setAttribute('data-theme', theme);
      themeSelector.value = theme;

      pomodoroApp.state.coins = s.coins || 0;
      pomodoroApp.state.selectedSound = s.selectedSound || 'sound_beep';
      if (s.unlockedItems) {
        pomodoroApp.shop.items.forEach(item => {
          if (s.unlockedItems.includes(item.id)) {
            item.unlocked = true;
          }
        });
      }
      this.updateCoinDisplay();
      this.renderHistory(JSON.parse(localStorage.getItem('pomodoro.history') || '[]'));
    },

    saveSettingsToStorage() {
      const { pomodoroInput, shortInput, longInput, cyclesInput, autoNext, notifToggle, themeSelector } = pomodoroApp.elements;
      const s = {
        pomodoro: Number(pomodoroInput.value),
        short: Number(shortInput.value),
        long: Number(longInput.value),
        cycles: Number(cyclesInput.value),
        autoNext: autoNext.checked,
        notif: notifToggle.checked,
        theme: themeSelector.value,
        coins: pomodoroApp.state.coins,
        selectedSound: pomodoroApp.state.selectedSound,
        unlockedItems: pomodoroApp.shop.items.filter(i => i.unlocked).map(i => i.id)
      };
      localStorage.setItem('pomodoro.settings', JSON.stringify(s));
    },

    showToast(message) {
      const { toast } = pomodoroApp.elements;
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    },

    bindEvents() {
      const { elements, methods } = pomodoroApp;
      elements.modeBtns.forEach(b => b.addEventListener('click', () => methods.setMode(b.dataset.mode)));
      elements.startBtn.addEventListener('click', () => methods.startTimer());
      elements.pauseBtn.addEventListener('click', () => methods.pauseTimer());
      elements.resetBtn.addEventListener('click', () => methods.resetTimer());
      elements.hamburgerBtn.addEventListener('click', () => {
        elements.rightPanel.classList.add('menu-open');
        elements.card.classList.add('menu-active');
      });
      elements.closeMenuBtn.addEventListener('click', () => {
        elements.rightPanel.classList.remove('menu-open');
        elements.card.classList.remove('menu-active');
      });
      elements.saveSettings.addEventListener('click', () => {
        methods.saveSettingsToStorage();
        methods.showToast('Configuraci√≥n guardada');
      });
      elements.resetSettings.addEventListener('click', () => {
        if (confirm('¬øSeguro que quieres borrar todos los ajustes y el historial?')) {
          localStorage.removeItem('pomodoro.settings');
          localStorage.removeItem('pomodoro.history');
          location.reload();
        }
      });
      elements.themeSelector.addEventListener('change', (e) => {
        document.documentElement.setAttribute('data-theme', e.target.value);
        methods.saveSettingsToStorage();
      });
      elements.shopContainer.addEventListener('click', (e) => methods.handleShopAction(e));
      elements.soundSelector.addEventListener('change', (e) => {
          pomodoroApp.state.selectedSound = e.target.value;
          methods.saveSettingsToStorage();
          methods.renderShop();
          methods.showToast('Sonido actualizado.');
      });
      document.addEventListener('keydown', (e) => {
        if(e.target.tagName === 'INPUT') return;
        if (e.code === 'Space') {
          e.preventDefault();
          pomodoroApp.state.running ? methods.pauseTimer() : methods.startTimer();
        }
        if (e.key.toLowerCase() === 'r') methods.resetTimer();
      });
    }
  },

  init() {
    this.methods.loadSettings();
    this.methods.setMode('pomodoro');
    this.methods.renderShop();
    this.methods.renderSoundSelector();
    this.methods.bindEvents();
    this.elements.startBtn.focus();
    console.log("Pomodoro App con Tienda inicializada correctamente.");
  }
};

document.addEventListener('DOMContentLoaded', () => pomodoroApp.init());
  </script>
</body>
</html>